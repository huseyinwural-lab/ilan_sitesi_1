# P5 Release Notes: Scale Hardening (v1.0)

**Date:** 2026-02-12
**Status:** Released
**Phase:** P5 (Scale Hardening)

## 1. Scope
Phase P5 focused on hardening the application for production scale, ensuring financial integrity, and protecting against abuse.

### Key Deliverables:
-   **Concurrency Hardening:** Implementation of `SELECT FOR UPDATE` row-level locking for `DealerSubscription` to prevent race conditions during quota consumption.
-   **Pricing Engine Gate:** Integration of the T2 Pricing Service as a mandatory "Hard Gate" in the listing publication flow. Missing configs now trigger `409 Conflict` (Fail-Fast).
-   **Expiry Job:** A daily background worker (`expiry_worker.py`) that transitions subscriptions from `active` to `expired` based on UTC timestamps.
-   **Rate Limiting:** A two-tier (User/IP) rate limiting system protecting critical endpoints (Auth, Listings, Checkout).

## 2. Security Gains
-   **Abuse Prevention:** Brute-force attacks on login/register are throttled (IP-based). Spam creation of listings is limited (User-based).
-   **Financial Integrity:** Strict idempotency and atomicity prevent double-billing and negative quota usage.
-   **Fail-Fast Security:** The system refuses to process transactions if pricing configurations are ambiguous or missing.

## 3. Performance Impact
-   **Latency:** Rate limiting adds negligible overhead (<1ms) due to in-memory lookups.
-   **Database:** Row-locking adds slight contention risk on the `dealer_subscriptions` table, but is necessary for correctness. Lock timeouts are managed by Postgres defaults.
-   **Indexing:** New indexes (`ix_dealer_subscriptions_status_end_at`) optimize the daily expiry job.

## 4. Known Limitations
-   **Rate Limiter:** Currently In-Memory. Limits are per-instance (not global).
-   **Expiry Job:** Processes all records in a single batch (fine for <10k subs).
-   **Config:** Rate limits are defined in code (migration planned).

## 5. Operational Requirements
-   **Cron:** Must run `/app/backend/start_cron.sh` daily at 00:00 UTC.
-   **Logs:** `SYSTEM_EXPIRE` audit logs must be monitored.
-   **Alerting:** 409 Conflict errors on `create_listing` should trigger operational alerts (Config Missing).

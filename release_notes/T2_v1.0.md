# Release Notes - Phase T2: Advanced Pricing Engine (v1.0)

## Scope
Phase T2 delivers a sophisticated, database-driven pricing engine that replaces hardcoded fee logic. It introduces a "Waterfall" pricing model that deterministically calculates listing costs based on available quotas and configurations.

**Included:**
- **Waterfall Pricing Logic:** Automatically selects the best price source:
  1.  **Free Quota:** Rolling window (e.g., 10 listings/30 days).
  2.  **Subscription Quota:** Prepaid dealer packages.
  3.  **Overage (Pay-per-listing):** Chargeable extras when quotas are full.
- **Strict Idempotency:** Prevents double-charging for the same listing.
- **Concurrency Protection:** Uses row-level locking (`SELECT FOR UPDATE`) to ensure quota integrity under high load.
- **Immutable Invoice Snapshots:** Stores price, VAT, and config version at the moment of purchase.
- **Fail-Fast Configuration:** Blocks listing creation if critical pricing or VAT configs are missing.

**Excluded (Deferred to Future Phases):**
- Complex Discount Stacking (P5+).
- Dynamic Price Adjustments based on demand (Dynamic Pricing).
- Recurring Stripe Subscriptions (currently fixed-duration packages).

## Acceptance Checklist
- [x] **Waterfall Logic Verified:** Free -> Sub -> Overage sequence works as expected.
- [x] **Idempotency Enforced:** Repeated calls for the same listing return success without double-charging.
- [x] **Atomicity Guaranteed:** Quota decrement, consumption log, and invoice item creation happen in a single transaction.
- [x] **Concurrency Hardened:** Row-level locking prevents race conditions on subscription quotas.
- [x] **Fail-Fast Active:** Missing `PriceConfig` or `VatRate` raises `PricingConfigError` immediately.
- [x] **Snapshot Immutability:** `InvoiceItem` retains historical price data even if global config changes.
- [x] **Tests Passed:** All unit and integration tests in `tests/test_p5_pricing.py` are green.

## Config Preconditions
For the system to function per country, the following Database Configurations are **MANDATORY**:

1.  **CountryCurrencyMap:** `DE` -> `EUR`, `CH` -> `CHF`.
2.  **VatRate:** Active `standard` rate for the country (e.g., 19.00 for `DE`).
3.  **PriceConfig:** Active record for:
    - `segment='dealer'`
    - `pricing_type='pay_per_listing'`
    - `country='{CODE}'`
4.  **FreeQuotaConfig (Optional):** If defined, enables the first step of the waterfall. If missing, logic skips to Subscription.

## Risks & Mitigations
- **Risk:** Admin forgets to add `PriceConfig` for a new country.
  - **Mitigation:** System returns a clear error message preventing listing publication. Operational Health Check (Backlog item) will monitor this.
- **Risk:** DB Locking causes performance bottleneck.
  - **Mitigation:** Lock scope is minimized to the specific `DealerSubscription` row. Timeout monitoring is in place.

## Migration & Observability
- **Migration:** `0e44994b5f92` applied schema changes for `PriceConfig`, `FreeQuotaConfig`, `ListingConsumptionLog`.
- **Observability:**
  - Table `listing_consumption_logs` provides a full audit trail of every listing charge.
  - New error classes (`PricingConfigError`, `PricingConcurrencyError`) aid in debugging.

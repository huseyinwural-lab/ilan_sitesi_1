name: RBAC Map Coverage Gate

on:
  pull_request:
    paths:
      - "backend/server.py"
      - "docs/RBAC_ENDPOINT_MAP.md"
      - "backend/scripts/check_rbac_coverage.py"
      - ".github/workflows/rbac-coverage.yml"
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  rbac-coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: RBAC map coverage
        id: rbac
        run: |
          set +e
          python backend/scripts/check_rbac_coverage.py > rbac_output.txt 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT
          cat rbac_output.txt
      - name: Comment PR with coverage summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('rbac_output.txt', 'utf8');
            const exitCode = '${{ steps.rbac.outputs.exit_code }}';
            const header = exitCode === '0' ? '✅ RBAC coverage OK' : '❌ RBAC coverage failed';
            const body = `${header}\n\n\`\`\`\n${output}\n\`\`\``;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body,
            });
      - name: Fail if coverage fails
        if: steps.rbac.outputs.exit_code != '0'
        run: exit 1
